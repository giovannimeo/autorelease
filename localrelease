#!/bin/bash

# This script force maven release plugin 2.5 because it has:
# http://jira.codehaus.org/browse/MRELEASE-767
# http://jira.codehaus.org/browse/MRELEASE-812
# Very much needed for GIT repositories

function usage {
    echo "Usage: $0 [--ignoresnapshots] [--debug] [--localrepodir <local repo directory>] [--stagingrepodir <staging repo directory>] [--profiles <profiles to enable>] [--logsdir <log directory>] [--domajor]"
    exit 1
}

# Get the full path of the current directory
fullpath=`readlink -f "${PWD}"`
basedir="${fullpath}"
scriptdirpath=`readlink -f $0`
scriptdir=`dirname ${scriptdirpath}`
ignoresnapshots="false"
debug=0
unknown_option=0
profiles="integrationtests"
# By default use a localrepodir for deploy and local resolution that is in the current directory
localrepodir="${basedir}/localrepodir"
stagingrepodir="${scriptdir}/stagingreleases"
logsdir="${scriptdir}/logs"
settingsfile="${scriptdir}/localreleasesettings.xml"
localm2repo="${basedir}/.m2repo"
version_date_prefix=`date '+v%Y%m%d%H%M%S'`
gitbundlerepo=""
domajor=0
while true ; do
    case "$1" in
        --localm2repo) shift; localm2repo="$1"; shift;;
        --settingsfile) shift; settingsfile="$1"; shift;;
        --domajor) domajor=1; shift;;
        --ignoresnapshots) ignoresnapshots="true"; shift;;
        --debug) debug=1; shift;;
        --localrepodir) shift; localrepodir="$1"; shift;;
        --profiles) shift; profiles="$1"; shift;;
        --logsdir) shift; logsdir="$1"; shift;;
        --stagingrepodir) shift; stagingrepodir="$1"; shift;;
        --version_date_prefix) shift; version_date_prefix="$1"; shift;;
        --gitbundlerepo) shift; gitbundlerepo="$1"; shift;;
	-*) echo "Unknown option $1"; unknown_option=1; shift;;
	*) break ;;
    esac
done

if [ "${unknown_option}" == "1" ]; then
    usage
    exit 1
fi

echo "LOCALRepo Directory is: ${localrepodir}"
echo "STAGINGRepo Directory is: ${stagingrepodir}"

# Make sure to escape /\: so if you want to get \: you have to write \\\:
#localscm="scm\\\:git\\\:ssh\\\:\/\/xnc-build.cisco.com\/gerrit\\\:29418\/odp-openflowjava-mirror"

basebranch="baseforrelease"
git show-ref --verify --quiet "refs/heads/${basebranch}"
branchdoesntexist=$?
if [ ${branchdoesntexist} != 0 ]; then
    echo "Noone setup the baseforrelease branch"
    exit 1
fi

basebranch_initial="baseforrelease_initial"
git show-ref --verify --quiet "refs/heads/${basebranch_initial}"
branchdoesntexist=$?
if [ ${branchdoesntexist} != 0 ]; then
    echo "Noone setup the baseforrelease_initial branch"
    exit 1
fi

gitshorthead=`git log ${basebranch_initial} --pretty="%h" -n 1`
if [ "${gitshorthead}" != "" ]; then gitshorthead="_${gitshorthead}"; fi
lockedversion="${version_date_prefix}${gitshorthead}"

# Now let see if we have an update version tag in that case lets include in the bundle create
updateversiontag=""
git show-ref refs/tags/update-cross-project-versions && updateversiontag=update-cross-project-versions

# Now save the repository in git bundle if a file is provided, till this point
if [ ! "${gitbundlerepo}" == "" ]; then
    git bundle create "${gitbundlerepo}" "${basebranch_initial}" "${basebranch}" ${updateversiontag}
fi

if [ ${debug} == 1 ]; then
    echo "VERSION:${lockedversion}"
fi

preparationbranch="preparation-branch-${lockedversion}"
preparationtag="preparation-tag-${lockedversion}"

# Checkout new branch and try to prepare for the release
# with the expected version number
git checkout -f "${basebranch}" -b "${preparationbranch}" && mvn -Dmaven.repo.local="${localm2repo}" -Dorg.ops4j.pax.url.mvn.localRepository="${localm2repo}" -s "${settingsfile}" -Dreleaseplugin.version=2.5 -Dmaven.release.version=2.5 -B org.apache.maven.plugins:maven-release-plugin:2.5:clean org.apache.maven.plugins:maven-release-plugin:2.5:prepare -DpushChanges=false -Dtag="${preparationtag}" -DcompletionGoals="help:system" -DpreparationGoals="clean install" -DignoreSnapshots=${ignoresnapshots} -P"${profiles}" -Darguments="-Dmaven.repo.local=\"${localm2repo}\" -Dorg.ops4j.pax.url.mvn.localRepository=\"${localm2repo}\" -s \"${settingsfile}\" -P${profiles}" -l "${logsdir}/preparation-branch.log" || exit 1

# Remove completedPhase so we can reuse the release.properties from scratch
sed -i '/^completedPhase/d' release.properties

# Replace the released version with the timestamped versions only and
# only if we are NOT doing a major release
if [ ${domajor} == 0 ]; then
    # Now replace all the project.rel with the timestamped version
    sed -i "s/\(^project\.rel\.[^=]*\)=\(.*\)/\1=\2-${lockedversion}/" release.properties
fi

# Now save the repository in git bundle if a file is provided till this point
if [ ! "${gitbundlerepo}" == "" ]; then
    git bundle create "${gitbundlerepo}" "${preparationtag}" "${basebranch_initial}" "${basebranch}" "${preparationbranch}" ${updateversiontag}
fi

localreleasebranch="autorelease-branch-${lockedversion}"
localreleasetag="autorelease-tag-${lockedversion}"

# Now attempt to do a release prepare, this time the branch will be the one will be pushed as well
# the tag that will be pushed
git checkout -f "${basebranch}" -b "${localreleasebranch}" && mvn -Dmaven.repo.local="${localm2repo}" -Dorg.ops4j.pax.url.mvn.localRepository="${localm2repo}" -s "${settingsfile}" -Dreleaseplugin.version=2.5 -Dmaven.release.version=2.5 -B org.apache.maven.plugins:maven-release-plugin:2.5:prepare -DpushChanges=false -Dtag="${localreleasetag}" -DcompletionGoals="help:system" -DpreparationGoals="clean install" -DignoreSnapshots=${ignoresnapshots} "-P${profiles}" -Darguments="-Dmaven.repo.local=\"${localm2repo}\" -Dorg.ops4j.pax.url.mvn.localRepository=\"${localm2repo}\" -s \"${settingsfile}\" -P${profiles}" -l "${logsdir}/localrelease-branch.log" || exit 1

# Now save the repository in git bundle if a file is provided, including the localrelease branch and tag
if [ ! "${gitbundlerepo}" == "" ]; then
    git bundle create "${gitbundlerepo}" "${localreleasetag}" "${preparationtag}" "${basebranch_initial}" "${basebranch}" "${localreleasebranch}" "${preparationbranch}" ${updateversiontag}
fi

# Now try to do a local deployment to make sure we can deploy the files appropriately
git checkout -f "${localreleasetag}" && mvn -Dmaven.repo.local="${localm2repo}" -Dorg.ops4j.pax.url.mvn.localRepository="${localm2repo}" -DaltDeploymentRepository="localdir::default::file:///${localrepodir}" -s "${settingsfile}" "-P${profiles}" clean javadoc:jar source:jar deploy -l "${logsdir}/localdeploy.log" || exit 1

# Deploy also the git bundlerepo so we keep in the same context
if [ ! "${gitbundlerepo}" == "" ]; then
    project=`basename "${gitbundlerepo}"`
    mvn -Dmaven.repo.local="${localm2repo}" -s "${settingsfile}" -Durl="file:///${localrepodir}"  -DrepositoryId="localdir" -DgroupId="org.opendaylight.gitbundles" -DartifactId="${project}" -Dversion="${lockedversion}" -Dpackaging="gitbundle" -Dclassifier="gitbundle" -Dfile="${gitbundlerepo}" deploy:deploy-file -l "${logsdir}/localdeploy_gitbundle.log"
fi
echo "DONE LOCALRELEASE last result is: $?"

exit 0
